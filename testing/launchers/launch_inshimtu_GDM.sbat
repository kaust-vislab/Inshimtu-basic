#!/bin/bash
#SBATCH --partition=debug
#SBATCH --job-name=inshimtu
#SBATCH --time=00:25:00
#SBATCH --output=inshimtu.%j.out
#SBATCH --error=inshimtu.%j.err                                     
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1


# TODO: Verify DataWarp BurstBuffer settings (remove DW_JOB_STRIPED overload when working)
##DW jobdw access_mode=striped capacity=10GiB type=scratch
##DW stage_in destination=$DW_JOB_STRIPED source=/lustre/project/k1033/Development/Inshimtu/examples/testing type=directory
##DW stage_in destination=$DW_JOB_STRIPED source=/lustre/project/k1033/Development/Inshimtu/examples/testing.done type=file
DW_JOB_STRIPED="/lustre/sw/vis/development/Inshimtu/examples"


# invoke: cd /scratch/$USER/pv-log && sbatch "$HOME/Development/Inshimtu/testing/launchers/launch_inshimtu_GDM.sbat"


## PATHS

#INSHIMTU_ROOT="/lustre/sw/vis/development/Inshimtu"
#INSHIMTU_DIR="${INSHIMTU_ROOT}/build.shaheen"

INSHIMTU_DIR="/lustre/sw/vis/development/Inshimtu/build.shaheen"
INSHIMTU_ROOT="/lustre/project/k1033/Development/Inshimtu"


SRC_DIR="$INSHIMTU_ROOT"

DEST_DIR="/scratch/$USER/inshimtu-testing"
DEVSHM_DIR="/dev/shm/$USER-inshimtu-testing"

## SETUP
echo "Setup GDM configuration"

WORK_DIR="${DEST_DIR}/test-GDM"
CONFIG_FILE="${WORK_DIR}/config.json"
DATA_DIR="${WORK_DIR}/data"

mkdir -p "${WORK_DIR}"

ln -fs "${SRC_DIR}/examples/data/GDM" "${DATA_DIR}" 
ln -fs "${SRC_DIR}/testing/configs/gdm_relpath.json" "${CONFIG_FILE}" 
ln -fs "${SRC_DIR}/testing/pipelines" "${WORK_DIR}" 


# MODULES

module use /lustre/sw/vis/modulefiles
module add Boost/1.61.0-CrayGNU-2016.07.KSL
module add ParaView/5.4.1-CrayGNU-2016.07.KSL-server-mesa
module add cray-hdf5-parallel/1.10.0.1


# RUN

srun --chdir="${WORK_DIR}" "$INSHIMTU_DIR/Inshimtu" -c "${CONFIG_FILE}"

