#!/bin/bash
#SBATCH --job-name=inshimtu
#SBATCH --time=00:25:00
#SBATCH --output=inshimtu.%j.out
#SBATCH --error=inshimtu.%j.err                                     
#SBATCH --gres=gpu
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
##SBATCH --partition=batch

## TODO: Enable for per-node data fragments using shared memory
#DEVSHM_DIR="/dev/shm/$USER-inshimtu-testing"


# invoke: cd /scratch/dragon/intel/$USER/pv-log && sbatch "/sw/vis/ibex-gpu/development/Inshimtu/testing/launchers/launch_inshimtu_GDM.ibex.sbat"


## PATHS

INSHIMTU_ROOT="/sw/vis/development/Inshimtu"
INSHIMTU_BUILD_DIR="${INSHIMTU_ROOT}/build.ibex"
INSHIMTU_EXEC="${INSHIMTU_BUILD_DIR}/Inshimtu"
INSHIMTU_MODULES="${INSHIMTU_BUILD_DIR}/module.init"
INSHIMTU_TESTING="${INSHIMTU_ROOT}/testing"

SRC_DIR="$HOME/Development/Inshimtu/examples"
#SRC_DIR="/lustre/project/k1033/Development/Inshimtu/examples"
#SRC_DIR="$DEVSHM_DIR"

DEST_DIR="/scratch/dragon/intel/$USER/inshimtu-testing"

## SETUP
echo "Setup GDM configuration"

WORK_DIR="${DEST_DIR}/test-GDM"
CONFIG_FILE="${WORK_DIR}/config.json"
DATA_DIR="${WORK_DIR}/data"

mkdir -p "${WORK_DIR}"

#ln -fns "${SRC_DIR}/data/GDM" "${DATA_DIR}"
if [ ! -d "${DATA_DIR}" ] ; then
  mkdir -p "${DATA_DIR}"
  rsync lmem-00.vis.kaust.edu.sa:"${SRC_DIR}/data/GDM/wrfout_d01_2015-10-27_0*" "${DATA_DIR}"
fi

ln -fs "${SRC_DIR}/testing/configs/gdm_relpath.json" "${CONFIG_FILE}"
ln -fs "${SRC_DIR}/testing/pipelines" "${WORK_DIR}"


# MODULES

if [ ! -e "${INSHIMTU_MODULES}" ]; then
  echo "Expecting modules: ${INSHIMTU_MODULES}"
  exit 1
fi
source "${INSHIMTU_MODULES}"


# RUN

if [ ! -x "${INSHIMTU_EXEC}" ]; then
  echo "Expecting executable: ${INSHIMTU_EXEC}"
  exit 1
fi

srun --chdir="${WORK_DIR}" "$INSHIMTU_EXEC" -c "${CONFIG_FILE}"

