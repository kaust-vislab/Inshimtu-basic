#!/bin/bash
#SBATCH --partition=debug
#SBATCH --job-name=inshimtu
#SBATCH --time=00:25:00
#SBATCH --output=inshimtu.%j.out
#SBATCH --error=inshimtu.%j.err                                     
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1


# TODO: Verify DataWarp BurstBuffer settings (remove DW_JOB_STRIPED overload when working)
##DW jobdw access_mode=striped capacity=10GiB type=scratch
##DW stage_in destination=$DW_JOB_STRIPED source=/lustre/project/k1033/Development/Inshimtu/examples/testing type=directory
##DW stage_in destination=$DW_JOB_STRIPED source=/lustre/project/k1033/Development/Inshimtu/examples/testing.done type=file
DW_JOB_STRIPED="/scratch/$USER/inshimtu-testing"


# invoke: pushd /scratch/$USER/pv-log && sbatch "$HOME/Development/Inshimtu/testing/launchers/launch_inshimtu_CycloneExtract.sbat"


## PATHS

#INSHIMTU_ROOT="/lustre/sw/vis/development/Inshimtu"
#INSHIMTU_BUILD_DIR="${INSHIMTU_ROOT}/build.shaheen"

INSHIMTU_BUILD_DIR="/lustre/sw/vis/development/Inshimtu/build.shaheen"
#INSHIMTU_BUILD_DIR="/lustre/sw/vis/development/Inshimtu/build.shaheen-sharedlibs"
INSHIMTU_EXEC="${INSHIMTU_BUILD_DIR}/Inshimtu"
INSHIMTU_MODULES="${INSHIMTU_BUILD_DIR}/module.init"

INSHIMTU_ROOT="/lustre/project/k1033/Development/Inshimtu"

SRC_DIR="$INSHIMTU_ROOT"

DEST_DIR="/scratch/$USER/inshimtu-testing"
DEVSHM_DIR="/dev/shm/$USER-inshimtu-testing"


## SETUP
echo "Setup CycloneExtract configuration"

WORK_DIR="${DEST_DIR}/test-cycloneextract"
CONFIG_FILE="${WORK_DIR}/config.json"
DATA_DIR="${WORK_DIR}/data"
FILTERS_DIR="${WORK_DIR}/filters"

mkdir -p "${WORK_DIR}"

cd "${WORK_DIR}"
ln -fns "${SRC_DIR}/examples/data/GDMncdata" "${DATA_DIR}"
ln -fs "${SRC_DIR}/testing/pipelines/cyclone_extract/cyclone_configs.json" "${CONFIG_FILE}" 
ln -fs "${SRC_DIR}/testing/pipelines" "${WORK_DIR}"
#ln -fns "${SRC_DIR}/testing/pipelines/cyclone_extract" "${FILTERS_DIR}"
ln -fns "${SRC_DIR}/examples/pipelines/cyclone_extract/filters" "${FILTERS_DIR}"
#export INSHIMTU_FILTER_SCRIPT_DIR="${SRC_DIR}/examples/pipelines/cyclone_extract/filters"


# MODULES


if [ ! -e "${INSHIMTU_MODULES}" ]; then
  echo "Expecting modules: ${INSHIMTU_MODULES}"
  exit 1
fi
source "${INSHIMTU_MODULES}"

# NOTE: LD_PRELOAD solves 'from mpi4py import MPI' import issue; but,
# only from pvpython, not from within Inshimtu
# Dynamic linking (-sharedlibs) doesn't help
#export MPI4PY_DIR="$(dirname "$(dirname "$(which pvpython)")")/lib/paraview-5.4/site-packages/mpi4py"
#export LD_PRELOAD="${MPI4PY_DIR}/MPI.so":"${MPI4PY_DIR}/dl.so":"${MPI4PY_DIR}/lib-pmpi/libmpe.so":"${MPI4PY_DIR}/lib-pmpi/libvt.so":"${MPI4PY_DIR}/lib-pmpi/libvt-mpi.so":"${MPI4PY_DIR}/lib-pmpi/libvt-hyb.so"

# RUN

if [ ! -x "${INSHIMTU_EXEC}" ]; then
  echo "Expecting executable: ${INSHIMTU_EXEC}"
  exit 1
fi

srun --chdir="${WORK_DIR}" "$INSHIMTU_EXEC" -c "${CONFIG_FILE}"

