#!/bin/bash
#SBATCH --partition=debug
#SBATCH --job-name=inshimtu
#SBATCH --time=00:25:00
#SBATCH --output=inshimtu.%j.out
#SBATCH --error=inshimtu.%j.err                                     
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1

# TODO: Example DataWarp BurstBuffer settings (remove DW_JOB_STRIPED overload when using)
##DW jobdw access_mode=striped capacity=10GiB type=scratch
##DW stage_in destination=$DW_JOB_STRIPED source=/lustre/project/k1033/Development/Inshimtu/examples/testing type=directory
##DW stage_in destination=$DW_JOB_STRIPED source=/lustre/project/k1033/Development/Inshimtu/examples/testing.done type=file
## TODO: Enable for testing DW workflow without using DW
#DW_JOB_STRIPED="/scratch/$USER/inshimtu-testing"
## TODO: Enable for per-node data fragments using shared memory
#DEVSHM_DIR="/dev/shm/$USER-inshimtu-testing"


# invoke: cd /scratch/$USER/pv-log && sbatch "$HOME/Development/Inshimtu/testing/launchers/launch_inshimtu_TestReadyFiles.sbat"


## PATHS

INSHIMTU_ROOT="/lustre/sw/vis/development/Inshimtu"
INSHIMTU_BUILD_DIR="${INSHIMTU_ROOT}/build.shaheen"
INSHIMTU_EXEC="${INSHIMTU_BUILD_DIR}/Inshimtu"
INSHIMTU_MODULES="${INSHIMTU_BUILD_DIR}/module.init"
INSHIMTU_TESTING="${INSHIMTU_ROOT}/testing"

SRC_DIR="/lustre/project/k1033/Development/Inshimtu/examples"
#SRC_DIR="$DEVSHM_DIR"
#SRC_DIR="${DW_JOB_STRIPED}data"

DEST_DIR="/scratch/$USER/inshimtu-testing"


#
# Helper functions
#
createHelperScript() {
HELPER_SCRIPT=$1
HELPER_DIR="$(dirname "$HELPER_SCRIPT")"
if [ ! -d "$HELPER_DIR" ] ; then
  echo "Invalid HELPER SCRIPT: ${HELPER_SCRIPT}"
  exit 1
fi

echo "Creating HELPER: ${HELPER_SCRIPT}"
cat <<'EOF' > "${HELPER_SCRIPT}"
#!/usr/bin/sh -e
echo "Running HELPER: ${HELPER_SCRIPT}"
echo "Initial Delay... 40s"
sleep 40
EOF
}


## SETUP
echo "Setup TestReadyFile configuration"

WORK_DIR="${DEST_DIR}/test-outready"
CONFIG_FILE="${WORK_DIR}/config.json"
DATA_DIR="${WORK_DIR}/data"
COHELPER_SCRIPT_SH="${WORK_DIR}/doDelayedReady.sh"

mkdir -p "${WORK_DIR}"

mkdir -p "${DATA_DIR}"
rm -f "${DATA_DIR}/"wrfoutReady_*
cd "${DATA_DIR}"
for dfile in "${SRC_DIR}/data/GDM"/wrfout_* ; do
  ln -fs "$dfile" "${DATA_DIR}"
done

cd "${WORK_DIR}"
ln -fs "${INSHIMTU_TESTING}/testing/configs/gdm_outready.json" "${CONFIG_FILE}" 
ln -fs "${INSHIMTU_TESTING}/testing/pipelines" "${WORK_DIR}" 
touch "${WORK_DIR}/data.done"

createHelperScript "$COHELPER_SCRIPT_SH"
for dfile in "${DATA_DIR}"/wrfout_* ; do
  dirpath="$(dirname "${dfile}")"
  fname="$(basename "${dfile}")"
  rfile="${dirpath}/${fname/wrfout_/wrfoutReady_}"
  echo "touch $rfile" >> "$COHELPER_SCRIPT_SH"
  echo "echo "Helper waiting... 20s"" >> "$COHELPER_SCRIPT_SH"
  echo "sleep 20" >> "$COHELPER_SCRIPT_SH"
done
chmod +x "$COHELPER_SCRIPT_SH"


# MODULES

if [ ! -e "${INSHIMTU_MODULES}" ]; then
  echo "Expecting modules: ${INSHIMTU_MODULES}"
  exit 1
fi
source "${INSHIMTU_MODULES}"


# RUN

if [ ! -x "${INSHIMTU_EXEC}" ]; then
  echo "Expecting executable: ${INSHIMTU_EXEC}"
  exit 1
fi

if [ ! -x "${COHELPER_SCRIPT_SH}" ]; then
  echo "Expecting executable script: ${COHELPER_SCRIPT_SH}"
  exit 1
fi

srun --chdir="${WORK_DIR}" "$COHELPER_SCRIPT_SH" &

srun --chdir="${WORK_DIR}" "$INSHIMTU_EXEC" -c "${CONFIG_FILE}"

